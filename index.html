<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>LIFF Form v1.4</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:linear-gradient(135deg,#6366f1,#22d3ee);
}
.card{
  max-width:420px;
  margin:20px auto;
  background:#fff;
  border-radius:20px;
  padding:20px;
  box-shadow:0 15px 40px rgba(0,0,0,.2);
}
img{width:90px;border-radius:50%;display:block;margin:auto}
h3{text-align:center}
label{display:block;margin-top:12px;font-weight:600}
input,select{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid #ddd;
}
button{
  width:100%;
  margin-top:16px;
  padding:14px;
  font-size:16px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#fff;
}
button:disabled{
  opacity:.6;
}
#loading{
  display:none;
  text-align:center;
  margin-top:15px;
}
#summary{display:none;text-align:center}
.spinner{
  width:36px;
  height:36px;
  border:4px solid #ddd;
  border-top:4px solid #22c55e;
  border-radius:50%;
  margin:auto;
  animation:spin 1s linear infinite;
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
</style>
</head>

<body>
<div class="card">

<div id="form">
  <img id="pic">
  <h3 id="lineName"></h3>

  <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
  <input id="inputName">

  <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
  <input id="phone" type="tel" maxlength="10">

  <label>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
  <select id="activity" onchange="updateItems()">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>
  </select>

  <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
  <select id="item">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
  </select>

  <button id="saveBtn" onclick="save()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

  <div id="loading">
    <div class="spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
  </div>
</div>

<div id="summary">
  <h3>‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
  <p id="sum"></p>
  <button onclick="location.reload()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
</div>

</div>

<script>
const LIFF_ID = "2008940385-hkDtMTsg";
const GAS_URL = "https://script.google.com/macros/s/AKfycbzHGWEA9JYbd1e9-cGnod10qrWuy-hz39IEDd1DhjkCa8bRP-D4qVLkGXNQbV2dcjNI/exec";

let profile={}, activityMap={};

async function init(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) liff.login();

  profile = await liff.getProfile();
  pic.src = profile.pictureUrl;
  lineName.innerText = profile.displayName;

  loadActivities();
}

async function loadActivities(){
  const res = await fetch(GAS_URL + "?mode=activity");
  const data = await res.json();

  activityMap = {};
  data.forEach(d=>{
    if(!activityMap[d.activity]) activityMap[d.activity]=[];
    activityMap[d.activity].push(d.item);
  });

  Object.keys(activityMap).forEach(a=>{
    activity.innerHTML += `<option value="${a}">${a}</option>`;
  });
}

function updateItems(){
  item.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>`;
  (activityMap[activity.value]||[]).forEach(i=>{
    item.innerHTML += `<option value="${i}">${i}</option>`;
  });
}

async function save(){
  saveBtn.disabled = true;
  loading.style.display = "block";

  const payload = {
    userId: profile.userId,
    displayName: profile.displayName,
    profilename: profile.displayName,
    inputName: inputName.value,
    phone: phone.value,
    activity: activity.value,
    item: item.value
  };

  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      mode: "no-cors",              // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LIFF
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    // LIFF no-cors ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô response ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    showSummary(payload);

  } catch (err) {
    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    saveBtn.disabled = false;
    loading.style.display = "none";
  }
}

function showSummary(data){
  form.style.display="none";
  summary.style.display="block";
  sum.innerHTML = `
    üë§ ${data.inputName}<br>
    üìû ${data.phone}<br>
    üéØ ${data.activity}<br>
    üìå ${data.item}
  `;
}

window.onload = init;
</script>
</body>
</html>
